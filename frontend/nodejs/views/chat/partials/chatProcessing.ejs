<script>
    // Process AI content, separating <think> tags from visible content
    function processAIContent(content) {
        const visibleContent = content.replace(/<think>[\s\S]*?<\/think>/g, "").trim();
        const thoughtMatches = content.match(/<think>[\s\S]*?<\/think>/g) || [];
        const thoughts = thoughtMatches.map(match=> match.replace(/<\/?think>/g, "").trim()).join("\n");
        return {
            thoughts: thoughts,
            visible: visibleContent
        };
    }
    function processQuizContent(content) {
        const cleaned = content.replace(/<think>[\s\S]*?<\/think>/g, "").trim();

        const questionMatch = cleaned.match(/QUIZ QUESTION:\s*([\s\S]*?)\s*CORRECT ANSWER:/i);
        const answerMatch = cleaned.match(/CORRECT ANSWER:\s*([\s\S]*?)$/i);

        const question = questionMatch ? questionMatch[1].trim() : '';
        const answer = answerMatch ? answerMatch[1].trim() : '';

        return {
            question,
            answer,
            full: cleaned
        };
    }

    // Render the full AI response into the container
    function renderFullResponse(fullRawContent, container, isFinal = false) {
        const $container = $(container);
        if ($container.length ===0) {
            console.error('Container not found for AI response.');
            return;
        }
        const processedContent = processAIContent(fullRawContent);
        $container.empty();
        // Retrieve the current default from settings.
        const thoughtsDefault = $('input[name="thoughtsDefault"]:checked').val();
        if (typeof window.persistedThoughtsState === 'undefined') {
            window.persistedThoughtsState = (thoughtsDefault === 'open');
        }
        container.innerHTML = '';

        // Process <think> content (hidden internal logic)
        if (processedContent.thoughts.trim()) {
            const detailsElement = document.createElement('details');
            detailsElement.className = 'ai-think';
            if (window.persistedThoughtsState) {
                detailsElement.setAttribute('open', '');
            }
            const summaryElement = document.createElement('summary');
            summaryElement.textContent = isFinal ? 'Thoughts' : 'Thinking...';
            detailsElement.appendChild(summaryElement);

            const innerDiv = document.createElement('div');
            innerDiv.className = 'markdown-content';
            innerDiv.innerHTML = processMathContent(processedContent.thoughts);
            detailsElement.appendChild(innerDiv);
            container.append(detailsElement);

            detailsElement.addEventListener('toggle', function () {
                window.persistedThoughtsState = detailsElement.open;
            });
        }

        // Process visible content
        if (processedContent.visible) {
            const visibleContentDiv = document.createElement('div');
            visibleContentDiv.className = 'markdown-content';
            visibleContentDiv.innerHTML = processMathContent(processedContent.visible);
            container.appendChild(visibleContentDiv);
        }

        // Trigger MathJax rendering
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([container]).catch(function (err) {
                console.error('MathJax typeset failed: ', err);
            });
        }
    }

    // Escape HTML entities to prevent script injection
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function (match) {
            const escapeMap = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;"
            };
            return escapeMap[match];
        });
    }
</script>
