<script>
    // Process AI content, separating <think> tags from visible content
    function processAIContent(content) {
        const visibleContent = content.replace(/<think>[\s\S]*?<\/think>/g, "").trim();
        const thoughtMatches = content.match(/<think>[\s\S]*?<\/think>/g) || [];
        const thoughts = thoughtMatches.map(match => match.replace(/<\/?think>/g, "").trim()).join("\n");

        let question = '';
        let answer = '';

        const quizMatch = visibleContent.match(/["']?\s*quiz question:\s*(.+?)\s+cor+rect\s+answer:\s*(.+?)["']?$/i);
        if (quizMatch) {
            question = quizMatch[1].trim();
            answer = quizMatch[2].trim();
        }

        return {
            thoughts,
            visible: question || visibleContent,
            question,
            answer
        };
    }


    // Render the full AI response into the container
    function renderFullResponse(fullRawContent, container, isFinal = false) {
        const $container = $(container);
        if ($container.length ===0) {
            console.error('Container not found for AI response.');
            return;
        }
        const processedContent = processAIContent(fullRawContent);
        $container.empty();
        // Retrieve the current default from settings.
        const thoughtsDefault = $('input[name="thoughtsDefault"]:checked').val();
        if (typeof window.persistedThoughtsState === 'undefined') {
            window.persistedThoughtsState = (thoughtsDefault === 'open');
        }
        container.innerHTML = '';

        // Process <think> content (hidden internal logic)
        if (processedContent.thoughts.trim()) {
            const detailsElement = document.createElement('details');
            detailsElement.className = 'ai-think';
            if (window.persistedThoughtsState) {
                detailsElement.setAttribute('open', '');
            }
            const summaryElement = document.createElement('summary');
            summaryElement.textContent = isFinal ? 'Thoughts' : 'Thinking...';
            detailsElement.appendChild(summaryElement);

            const innerDiv = document.createElement('div');
            innerDiv.className = 'markdown-content';
            innerDiv.innerHTML = processMathContent(processedContent.thoughts);
            detailsElement.appendChild(innerDiv);
            container.append(detailsElement);

            detailsElement.addEventListener('toggle', function () {
                window.persistedThoughtsState = detailsElement.open;
            });
        }

        // Process visible content
        if (processedContent.visible) {
            const visibleContentDiv = document.createElement('div');
            visibleContentDiv.className = 'markdown-content';
            let htmlWithLineBreaks = processedContent.visible.replace(/\n/g, '<br>');
            visibleContentDiv.innerHTML = processMathContent(htmlWithLineBreaks);
            container.appendChild(visibleContentDiv);
        }

        // Trigger MathJax rendering
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([container]).catch(function (err) {
                console.error('MathJax typeset failed: ', err);
            });
        }
    }

    // Escape HTML entities to prevent script injection
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function (match) {
            const escapeMap = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;"
            };
            return escapeMap[match];
        });
    }
</script>
