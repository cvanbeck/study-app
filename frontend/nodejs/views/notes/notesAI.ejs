<head>
    <link rel="stylesheet" type="text/css" href="/css/notes/notesPage.css" />
</head>

    <!-- Contains scripts from button.ejs -->
    <p><button id="newNoteButton">New Note</button> <button id="existingNoteSweetAlertButton">Load Note</button> <button id="joinButton">Join Collab Session</button> <button id="sessionButton">Create Collab Session</button></p> 
    <p> Session Code: <span id="sessionCode"></span></p>

    <!-- Note & AI chat container -->
    <div id="notes-container">
        <!-- Notes Editor -->
        <div id="editor-container">
            <div id="editor"></div>
        </div>

        <div id="ai-assistant">
            <h2>Ai Assistant</h2>
            <%- include('../chat/partials/chatSettings.ejs') %>

            <!-- Chat Form -->
            <form id="chat-form">
                <textarea id="prompt" name="prompt" placeholder="Message the AI" rows="1" required></textarea>
                <input type="hidden" id="response-mode" name="mode" value="default">
                <button type="submit">Send</button>
            </form>

        <div id="quizmaster-help" style="display: none; margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
            <h4 style="margin-top: 0;">Quizmaster Mode</h4>
            <p>When Quizmaster mode is active and output is set to "Notes Editor", the AI will post quiz questions directly to the shared notes.</p>
            <ul style="margin-bottom: 0;">
                <li><strong>Start a quiz:</strong> Type "start quiz [topic]" </li>
                <li><strong>Answer questions:</strong> Type your answer in the note (prefix your answer with your name and colon) </li>
                <li><strong>Next question</strong> Type "next question" or "next question [topic]" </li>
                <li><strong>End quiz:</strong> Type "end quiz" to finish. </li>
            </ul>
        </div>

            <div id="chat-output"></div>
            <%- include('../chat/partials/ui/chatUIMessages.ejs') %>
            <%- include('../chat/partials/ui/chatUIMarkup.ejs') %>
        </div>
    </div>

    <%- include('../notes/partials/note.ejs') %>


    <!-- AI Chat Processing -->
    <%- include('../chat/partials/chatProcessing.ejs') %>
    <%- include('../chat/partials/chatStream.ejs') %>
<script>
    function notesAIInit() {
        if(typeof UI !=='undefined' && typeof UI.init === 'function'){
            UI.init();
        }
        Editor.quill.on('text-change', function(delta, oldDelta, source){
            if(source!== 'user') return;
            delta.ops.forEach(op => {
                if (op.insert && typeof op.insert === 'string' && op.insert.includes('\n')){
                    const noteText = Editor.quill.getText().trim();
                    const lines = noteText.split('\n');
                    const lastLine = lines[lines.length -1];
                    const match = lastLine.match(/^([\w\s]+):\s*(.*)$/);
                    if(match){
                        const username=match[1].trim();
                        const userAnswer=match[2].trim();

                        $.ajax({
                            url:'/chat/getChatResponse',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                prompt: lastLine,
                                mode: 'quizmaster',
                                destination: 'note'
                            }),
                            success: function(res) {
                                const currentLength = Editor.quill.getLength();
                                Editor.quill.insertText(currentLength, `AI: ${res}\n`);
                                if (window.socket && typeof window.socket.emit === 'function') {
                                    const delta = Editor.quill.getContents();
                                    window.socket.emit('text-change', delta);
                                }
                            },
                            error: function(err) {
                                console.error("Quiz answer validation failed:", err);
                            }
                        });
                    }
                }
            });
        });
    }

    $(document).ready(notesAIInit);
    </script>
